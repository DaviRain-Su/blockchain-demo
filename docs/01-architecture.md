# 区块链演示项目 - 架构设计文档

## 项目概述

这是一个用 Zig 语言实现的简易区块链演示项目，展示了区块链的核心概念和基本实现。项目包含以下核心功能：

- 区块结构与链式存储
- SHA-256 哈希计算
- 工作量证明（Proof of Work）挖矿机制
- 点对点（P2P）网络通信
- 多线程并发处理

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          应用层 (main.zig)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  命令行解析   │  │  主线程控制  │  │      挖矿循环线程        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                        核心层                                     │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
│  │   blockchain.zig        │  │      network.zig            │   │
│  │  ┌───────┐ ┌──────────┐ │  │  ┌──────┐ ┌──────┐ ┌─────┐ │   │
│  │  │ Block │ │Blockchain│ │  │  │ Node │ │ Peer │ │Message│   │
│  │  └───────┘ └──────────┘ │  │  └──────┘ └──────┘ └─────┘ │   │
│  └─────────────────────────┘  └─────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                        基础设施层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  std.crypto  │  │   std.net    │  │     std.Thread       │   │
│  │  (SHA-256)   │  │  (TCP通信)    │  │     (多线程)          │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 模块职责

### main.zig - 应用入口

| 功能 | 描述 |
|------|------|
| 命令行参数解析 | 解析监听端口和对等节点端口 |
| 初始化 | 创建区块链和网络节点实例 |
| 线程管理 | 启动服务器线程和挖矿线程 |
| 生命周期控制 | 管理程序运行时间和资源释放 |

### blockchain.zig - 区块链核心

| 组件 | 职责 |
|------|------|
| Block | 单个区块的数据结构和操作 |
| Blockchain | 区块链的管理和验证 |

### network.zig - 网络通信

| 组件 | 职责 |
|------|------|
| Node | 网络节点，管理连接和消息 |
| Peer | 对等节点连接信息 |
| Message | 网络消息定义 |
| 序列化函数 | 消息的编码和解码 |

### root.zig - 库导出

作为库模块的入口点，供外部项目引用。

## 数据流

```
启动流程:
┌──────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│ 解析参数  │ -> │ 创建区块链    │ -> │ 创建创世块   │ -> │ 创建网络节点  │
└──────────┘    └──────────────┘    └─────────────┘    └──────────────┘
                                                              │
                     ┌────────────────────────────────────────┘
                     ▼
              ┌─────────────┐    ┌─────────────┐
              │ 连接对等节点 │ -> │ 启动服务线程  │
              └─────────────┘    └─────────────┘
                                       │
                     ┌─────────────────┴─────────────────┐
                     ▼                                   ▼
              ┌─────────────┐                    ┌─────────────┐
              │ 服务器线程   │                    │  挖矿线程    │
              │ (接收消息)   │                    │ (生成新块)   │
              └─────────────┘                    └─────────────┘

挖矿流程:
┌──────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│ 获取最新块 │ -> │ 创建新区块    │ -> │ 执行PoW挖矿  │ -> │ 添加到链上    │
└──────────┘    └──────────────┘    └─────────────┘    └──────────────┘
                                                              │
                                                              ▼
                                                       ┌──────────────┐
                                                       │ 广播给对等节点 │
                                                       └──────────────┘

消息接收流程:
┌──────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│ 接收TCP数据│ -> │ 反序列化消息  │ -> │  验证区块    │ -> │ 添加到本地链  │
└──────────┘    └──────────────┘    └─────────────┘    └──────────────┘
```

## 线程模型

```
主线程 (main)
    │
    ├── 初始化资源
    │
    ├── spawn ──────────────────> 服务器线程 (startServer)
    │                                   │
    │                                   ├── accept 循环
    │                                   │
    │                                   └── spawn ──> 连接处理线程 (handleConnection)
    │                                                       │
    │                                                       └── 读取/处理消息循环
    │
    ├── spawn ──────────────────> 挖矿线程 (miningLoop)
    │                                   │
    │                                   └── 挖矿循环 (无限)
    │
    ├── sleep 10秒
    │
    └── 退出 (join 线程)
```

## 依赖关系

```
main.zig
    │
    ├── std (标准库)
    │
    ├── blockchain.zig
    │       │
    │       └── std.crypto.hash.sha2.Sha256
    │
    └── network.zig
            │
            ├── blockchain.zig (Block, Blockchain)
            │
            └── std.net (TCP网络)
```

## 内存管理策略

项目采用显式内存管理：

1. **分配器传递**: 所有需要动态内存的结构都接收 `std.mem.Allocator`
2. **init/deinit 模式**: 每个结构体都有对应的初始化和销毁方法
3. **defer 释放**: 使用 `defer` 确保资源在作用域结束时释放
4. **测试时检测泄漏**: 使用 `std.testing.allocator` 自动检测内存泄漏

## 线程安全策略

使用互斥锁保护共享数据：

1. **Blockchain.mutex**: 保护区块列表的并发访问
2. **Node.mutex**: 保护对等节点列表的并发访问
3. **锁定模式**: `mutex.lock(); defer mutex.unlock();`
4. **Unsafe 方法**: 提供不加锁的版本供调用者自行管理锁

## 配置参数

| 参数 | 当前值 | 位置 | 说明 |
|------|--------|------|------|
| 挖矿难度 | 24 | blockchain.zig:81,90, main.zig:55 | 哈希前导零位数 |
| 监听端口 | 8000 | main.zig:15 (默认) | TCP服务端口 |
| 对等端口 | 8001 | main.zig:16 (默认) | 连接的对等节点端口 |
| 运行时间 | 10秒 | main.zig:47 | 主线程等待时间 |
| 接收缓冲区 | 1024字节 | network.zig:162 | 单次读取最大字节 |
